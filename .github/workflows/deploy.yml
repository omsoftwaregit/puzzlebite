name: Deploy React + Vite to S3
 
on:

  push:

    branches:

      - main  # Run on push to main branch
 
jobs:

  deploy:

    name: Build and Deploy

    runs-on: ubuntu-latest
 
    steps:

      # Step 1: Checkout the repository

      - name: Checkout repository

        uses: actions/checkout@v3
 
      # Step 2: Setup Node.js

      - name: Setup Node.js

        uses: actions/setup-node@v3

        with:

          node-version: 20
 
      # Step 3: Install dependencies

      - name: Install dependencies

        run: npm install
 
      # Step 4: Build the React + Vite project

      - name: Build project

        run: npm run build
 
      # Step 5: Configure AWS credentials

      - name: Configure AWS credentials

        uses: aws-actions/configure-aws-credentials@v2

        with:

          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          aws-region: ap-south-1
 
      # Step 6: Deploy to S3

      - name: Deploy to S3

        run: |

          aws s3 sync ./dist s3://puzzlebite-frontend --delete

          aws s3 cp ./dist/index.html s3://puzzlebite-frontend/index.html
 
      # Step 7: Invalidate CloudFront cache (optional)

      - name: Invalidate CloudFront cache

        if: ${{ env.CF_DISTRIBUTION_ID }}

        env:

          CF_DISTRIBUTION_ID: ${{ secrets.CF_DISTRIBUTION_ID }}

        run: |

          aws cloudfront create-invalidation \

            --distribution-id $CF_DISTRIBUTION_ID \

            --paths "/*"

 